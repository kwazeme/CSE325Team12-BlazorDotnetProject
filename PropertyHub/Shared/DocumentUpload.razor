@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@using PropertyHub.Data
@inject NavigationManager Navigation
@inject IHttpClientFactory HttpClientFactory

<div class="document-upload">
    @if (!string.IsNullOrWhiteSpace(Label))
    {
        <label class="form-label">@Label</label>
    }
    <InputFile OnChange="HandleSelected" accept="@AcceptAttribute" disabled="@Disabled" />
    @if (!string.IsNullOrWhiteSpace(HelperText))
    {
        <div class="form-text">@HelperText</div>
    }
    @if (!string.IsNullOrWhiteSpace(StatusMessage))
    {
        <div class="small text-muted mt-1">@StatusMessage</div>
    }
    @if (!string.IsNullOrWhiteSpace(ErrorMessage))
    {
        <div class="small text-danger mt-1">@ErrorMessage</div>
    }
</div>

@code {
    [Parameter] public string UploadUrl { get; set; } = "api/documents/upload";
    [Parameter] public string? Folder { get; set; }
    [Parameter] public string? Label { get; set; } = "Upload document";
    [Parameter] public string? HelperText { get; set; }
    [Parameter] public long MaxFileSizeBytes { get; set; } = 10 * 1024 * 1024;
    [Parameter] public string[] AllowedExtensions { get; set; } = new[] { ".pdf", ".png", ".jpg", ".jpeg", ".doc", ".docx" };
    [Parameter] public EventCallback<DocumentUploadResult> OnUploaded { get; set; }
    [Parameter] public EventCallback<string> OnError { get; set; }
    [Parameter] public bool Disabled { get; set; }

    private string? StatusMessage;
    private string? ErrorMessage;
    private bool IsUploading;

    private string AcceptAttribute =>
        AllowedExtensions is { Length: > 0 } ? string.Join(",", AllowedExtensions) : string.Empty;

    private async Task HandleSelected(InputFileChangeEventArgs args)
    {
        ErrorMessage = null;
        StatusMessage = null;

        var file = args.File;
        if (file is null)
        {
            return;
        }

        if (IsUploading)
        {
            return;
        }

        var extension = Path.GetExtension(file.Name);
        if (AllowedExtensions?.Length > 0 &&
            !AllowedExtensions.Any(allowed => string.Equals(allowed, extension, StringComparison.OrdinalIgnoreCase)))
        {
            ErrorMessage = $"File type not allowed. Allowed: {string.Join(", ", AllowedExtensions)}";
            await NotifyErrorAsync(ErrorMessage);
            return;
        }

        if (file.Size > MaxFileSizeBytes)
        {
            ErrorMessage = $"File exceeds {MaxFileSizeBytes / (1024 * 1024)} MB limit.";
            await NotifyErrorAsync(ErrorMessage);
            return;
        }

        IsUploading = true;

        try
        {
            var client = HttpClientFactory.CreateClient();
            client.BaseAddress = new Uri(Navigation.BaseUri);

            using var content = new MultipartFormDataContent();
            await using var fileStream = file.OpenReadStream(MaxFileSizeBytes);
            using var streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType ?? "application/octet-stream");

            content.Add(streamContent, "file", file.Name);

            if (!string.IsNullOrWhiteSpace(Folder))
            {
                content.Add(new StringContent(Folder), "folder");
            }

            var response = await client.PostAsync(UploadUrl, content);
            if (!response.IsSuccessStatusCode)
            {
                var body = await response.Content.ReadAsStringAsync();
                ErrorMessage = string.IsNullOrWhiteSpace(body) ? "Upload failed." : body;
                await NotifyErrorAsync(ErrorMessage);
                return;
            }

            var result = await response.Content.ReadFromJsonAsync<DocumentUploadResult>();
            if (result is null)
            {
                ErrorMessage = "Upload failed.";
                await NotifyErrorAsync(ErrorMessage);
                return;
            }

            StatusMessage = "Upload complete.";
            await OnUploaded.InvokeAsync(result);
        }
        catch (Exception ex)
        {
            ErrorMessage = "Upload failed.";
            await NotifyErrorAsync(ex.Message);
        }
        finally
        {
            IsUploading = false;
        }
    }

    private async Task NotifyErrorAsync(string message)
    {
        if (OnError.HasDelegate)
        {
            await OnError.InvokeAsync(message);
        }
    }
}
